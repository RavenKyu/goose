function Util(){this.removeBR=function(t){t.find("br").replaceWith(" ")},this.stringLimiter=function(t,e){var n=t.text();n.length>e&&t.text(n.substring(0,e))},this.removeSpace=function(t){t.text(t.text().replace(/\s+/g,""))}}function IndexEvent(t){function e(t){return t.children("dl").children("dt").children("button")}function n(t){var e=t.find("> ul > li").length;t.find("> dl em.count").text(e)}function o(t){t.each(function(t){$(this).find("> dl > dt > em.no").text(t)})}function i(t){var e=t.find("> dl > dt > strong");e.on("blur",function(){f.removeBR($(this)),f.removeSpace($(this)),f.stringLimiter($(this),20)})}function r(t){var e=t.closest("li");t.filter("[role=control]").on("click",function(t){t.stopPropagation(),c.off(e),c.on(e,$(this))}),t.filter("[role=toggle]").on("click",function(){e.toggleClass("on")})}var a=this,c=t._context,l=t.index,p=t.context,d=l.children().children("li[loc=root]"),f=new Util;c.getIndex(this),this.insertItem=function(t){var o={contenteditable:!0,spellcheck:!1},a=t.active.children("ul"),c=a.children("li").length,l=$("<li/>").attr("type",t.type).addClass("on").append($("<dl/>").append($("<dt/>").append($("<button/>").attr({type:"button",role:"move"}).text("move")).append($("<button/>").attr({type:"button",role:"control"}).text("control")).append($("<em/>").addClass("no").text(c)).append($("<button/>").attr({type:"button",role:"toggle"}).text("toggle")).append($("<strong/>").attr(o).attr("data-ph",t.type)).append($("<span/>").addClass("type")).append($("<em/>").addClass("count").text("0"))).append($("<dd/>").append($("<span/>").attr(o)))).append($("<ul/>"));t.data&&(l.find("dt strong").text(t.data.key),l.find("dd span").text(t.data.value)),r(e(l)),i(l),t.active.addClass("on").children("ul").append(l),n(t.active),t.complete&&t.complete(l)},this.typeItem=function(t){t.active.attr("type",t.type),t.active.find("> dl > dt > strong").attr("data-ph",t.type)},this.duplicateItem=function(t){var a=t.clone().insertAfter(t).find("li").andSelf();a.each(function(){r(e($(this))),i($(this))}),n(t.parent().parent()),o(t.parent().children())},this.removeItem=function(t){var e=t.parent().parent();t.remove(),n(e)},this.importJSON=function(t,e){function n(t,e){$.each(t,function(t,o){var i={key:t,value:o},r=null;"string"==typeof o?r="String":"object"==typeof o&&(r=Array.isArray(o)?"Array":"Object"),a.insertItem({active:e,type:r,data:i,complete:function(t){"String"!==r&&Object.size(o)>0&&n(o,t)}})})}n(t,e)},this.exportJSON=function(t){function e(t,n){var o=t.children("ul").children("li");return o.length&&o.each(function(){var o=$(this),i=o.find("> dl > dt > strong").text(),r=o.find("> dl > dd > span").text();switch($(this).attr("type")){case"String":"Array"==t.attr("type")?n.push(r):n[i]=r;break;case"Array":"Array"==t.attr("type")?n.push(e(o,new Array)):n[i]=e(o,new Array);break;case"Object":"Array"==t.attr("type")?n.push(e(o,new Object)):n[i]=e(o,new Object)}}),n}var n=e(d,"Array"==d.attr("type")?new Array:new Object);return JSON.stringify(n,null,t?t:0)},r(e(d));var s,u;d.children("ul").sortable({itemSelector:"li",handle:"button[role=move]",group:"index",pullPlaceholder:!0,onDrop:function(t,e,i){i(t),n(u.parent()),n(e.el.parent()),o(u.children()),o(e.el.children()),u=s=null},onDragStart:function(t,e,n){var o=t.offset(),i=e.rootGroup.pointer;s={left:i.left-o.left,top:i.top-o.top},u=e.el,n(t,e)},onDrag:function(t,e){t.css({left:e.left-s.left,top:e.top-s.top})},isValidTarget:function(t,e){return"String"==e.el.parent().attr("type")?!1:!0}})}function ContextEvent(t){var e=this,n=null,o=$("html"),i=t.index;context=t.context,active=null,this.getIndex=function(t){n=t},this.on=function(t,n){active=t,context.attr("type",t.attr("type")).css({left:n.position().left+n.outerWidth(),top:n.position().top-3}),"root"==t.attr("loc")?context.attr("loc",t.attr("loc")):context.removeAttr("loc"),o.on("click",function(){e.off()})},this.off=function(t){active=null,context.removeAttr("type"),o.off()},context.find("li").on("click",function(t){t.stopPropagation()}),context.find("li[role=Type] li").on("click",function(){n.typeItem({active:active,type:$(this).attr("role")}),e.off()}),context.find("li[role=Insert] li").on("click",function(){n.insertItem({active:active,type:$(this).attr("role"),data:null}),e.off()}),context.find("li[role=Duplicate]").on("click",function(){n.duplicateItem(active),e.off()}),context.find("li[role=Remove]").on("click",function(){n.removeItem(active),e.off()})}Object.size=function(t){var e=0,n;for(n in t)t.hasOwnProperty(n)&&e++;return e},function(t){var e=t("#jsonIndex"),n=t("#context"),o=e.find("li[loc=root]"),i=new ContextEvent({context:n,index:e}),r=new IndexEvent({index:e,context:n,_context:i});try{var a=JSON.parse(jsonData)}catch(c){var a=new Object}Array.isArray(a)&&r.typeItem({active:o,type:"Array"}),r.importJSON(a,o),t("form[name=post]").on("submit",function(){var e=t(this);e.find("input[name=json]").val(r.exportJSON(0))}),t("button[role=btn_toJSON]").on("click",function(){t("#result").text(r.exportJSON(5))})}(jQuery);